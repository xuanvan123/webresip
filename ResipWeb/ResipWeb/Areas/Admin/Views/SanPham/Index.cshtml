
@model IEnumerable<ResipWeb.Models.SanPham>
@{
    ViewData["Title"] = "Quản lý sản phẩm";
}

<style>
    .product-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        transition: transform 0.2s;
    }



    .stats-card {
        border-left: 4px solid;
        transition: all 0.3s;
    }



    .action-btn {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
    }



    .search-box {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        transition: all 0.3s;
    }

        .search-box:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.15);
        }

    .filter-chip {
        cursor: pointer;
        transition: all 0.2s;
    }



        .filter-chip.active {
            background-color: #0d6efd !important;
            color: white !important;
        }

    .table-hover tbody tr {
        transition: all 0.2s;
    }



    .empty-state {
        padding: 60px 20px;
        text-align: center;
    }

        .empty-state i {
            font-size: 64px;
            color: #dee2e6;
        }
</style>

<div class="container-fluid px-4">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 fw-bold">
                <i class="bi bi-box-seam text-primary me-2"></i>Quản lý sản phẩm
            </h1>
            <p class="text-muted mb-0">Quản lý toàn bộ sản phẩm trong hệ thống</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="exportToExcel()">
                <i class="bi bi-download me-1"></i> Xuất Excel
            </button>
            <a asp-action="Create" class="btn btn-success">
                <i class="bi bi-plus-circle me-1"></i> Thêm sản phẩm
            </a>
        </div>
    </div>

    <!-- STATISTICS -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card stats-card border-0 shadow-sm" style="border-left-color: #0d6efd;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Tổng sản phẩm</p>
                            <h3 class="mb-0 fw-bold" id="totalProducts">@Model.Count()</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-box-seam fs-4 text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 shadow-sm" style="border-left-color: #198754;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Đang hiển thị</p>
                            <h3 class="mb-0 fw-bold text-success" id="activeProducts">@Model.Count(x => x.IsActive)</h3>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-eye fs-4 text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 shadow-sm" style="border-left-color: #6c757d;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Đang ẩn</p>
                            <h3 class="mb-0 fw-bold text-secondary" id="inactiveProducts">@Model.Count(x => !x.IsActive)</h3>
                        </div>
                        <div class="bg-secondary bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-eye-slash fs-4 text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 shadow-sm" style="border-left-color: #dc3545;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Sắp hết hàng</p>
                            <h3 class="mb-0 fw-bold text-danger">0</h3>
                        </div>
                        <div class="bg-danger bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-exclamation-triangle fs-4 text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SEARCH & FILTER -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control search-box border-start-0"
                               id="searchInput"
                               placeholder="Tìm kiếm theo tên, SKU..."
                               onkeyup="filterProducts()">
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="d-flex gap-2 flex-wrap">
                        <span class="badge bg-light text-dark filter-chip active" onclick="filterByStatus('all')">
                            <i class="bi bi-grid me-1"></i> Tất cả
                        </span>
                        <span class="badge bg-light text-dark filter-chip" onclick="filterByStatus('active')">
                            <i class="bi bi-eye me-1"></i> Đang hiển thị
                        </span>
                        <span class="badge bg-light text-dark filter-chip" onclick="filterByStatus('inactive')">
                            <i class="bi bi-eye-slash me-1"></i> Đang ẩn
                        </span>
                        <div class="vr"></div>
                        <select class="form-select form-select-sm" style="width: auto;" onchange="sortProducts(this.value)">
                            <option value="">Sắp xếp theo</option>
                            <option value="name-asc">Tên A-Z</option>
                            <option value="name-desc">Tên Z-A</option>
                            <option value="price-asc">Giá thấp - cao</option>
                            <option value="price-desc">Giá cao - thấp</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BULK ACTIONS -->
    <div class="card shadow-sm border-0 mb-3" id="bulkActionsBar" style="display: none;">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="text-muted">Đã chọn <strong id="selectedCount">0</strong> sản phẩm</span>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-success" onclick="bulkAction('activate')">
                        <i class="bi bi-eye"></i> Hiển thị
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="bulkAction('deactivate')">
                        <i class="bi bi-eye-slash"></i> Ẩn
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="bulkAction('delete')">
                        <i class="bi bi-trash"></i> Xóa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="productsTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width:50px" class="text-center">
                                <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th style="width:80px">Ảnh</th>
                            <th>Thông tin sản phẩm</th>
                            <th style="width:130px">Giá bán</th>
                            <th style="width:100px" class="text-center">Tồn kho</th>
                            <th style="width:100px" class="text-center">Trạng thái</th>
                            <th style="width:200px" class="text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var sp in Model)
                        {
                            <tr data-id="@sp.Id" data-status="@(sp.IsActive ? "active" : "inactive")">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input row-checkbox" onchange="updateBulkActions()">
                                </td>
                                <td align="center">
                                    <img src="@Url.Content(sp.AnhChinh)"
                                         class="product-img"
                                         alt="@sp.TenSanPham"
                                         onerror="this.src='/images/no-image.png'" />
                                </td>
                                <td>
                                    <strong class="d-block mb-1">@sp.TenSanPham</strong>
                                    <span class="badge bg-light text-dark small">SKU: @sp.SKU</span>
                                    @if (sp.Category != null)
                                    {
                                        <span class="badge bg-info text-white small ms-1">
                                            @sp.Category.Name
                                        </span>
                                    }
                                </td>
                                <td>
                                    <span class="fw-bold text-danger d-block">
                                        @sp.GiaBan.ToString("N0") đ
                                    </span>
                                    @if (sp.GiaCu.HasValue && sp.GiaCu > sp.GiaBan)
                                    {
                                        <small class="text-muted text-decoration-line-through">
                                            @sp.GiaCu.Value.ToString("N0") đ
                                        </small>
                                    }
                                </td>
                                <td class="text-center">
                                    <span class="badge @(sp.StockQuantity > 10 ? "bg-success" : sp.StockQuantity > 0 ? "bg-warning" : "bg-danger")">
                                        @sp.StockQuantity
                                    </span>
                                </td>
                                <td class="text-center">
                                    @if (sp.IsActive)
                                    {
                                        <span class="badge bg-success">Hiển thị</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Ẩn</span>
                                    }
                                </td>
                                <td class="text-center">
                                    <div class="d-flex gap-1 justify-content-center">

                                        <a asp-controller="SanPham"
                                           asp-action="ChiTiet"
                                           asp-route-id="@sp.Id"
                                           asp-area="" class="btn btn-sm btn-outline-info action-btn" target="_blank"
                                           title="Xem chi tiết">
                                            <i class="bi bi-eye"></i>
                                        </a>

                                        <a asp-controller="SanPham"
                                           asp-action="Edit"
                                           asp-route-id="@sp.Id"
                                           asp-area="Admin" class="btn btn-sm btn-outline-warning action-btn"
                                           title="Sửa">
                                            <i class="bi bi-pencil"></i>
                                        </a>

                                        <a asp-controller="SanPham"
                                           asp-action="Duplicate"
                                           asp-route-id="@sp.Id"
                                           asp-area="Admin" class="btn btn-sm btn-outline-secondary action-btn"
                                           title="Nhân bản">
                                            <i class="bi bi-files"></i>
                                        </a>

                                        <a asp-controller="SanPham"
                                           asp-action="Delete"
                                           asp-route-id="@sp.Id"
                                           asp-area="Admin" class="btn btn-sm btn-outline-danger action-btn"
                                           onclick="return confirm('Xóa sản phẩm này?')"
                                           title="Xóa">
                                            <i class="bi bi-trash"></i>
                                        </a>

                                    </div>
                                </td>

                            </tr>
                        }
                    </tbody>

                </table>
            </div>

            <!-- EMPTY STATE -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="bi bi-inbox"></i>
                <h5 class="mt-3 text-muted">Không tìm thấy sản phẩm</h5>
                <p class="text-muted">Thử thay đổi bộ lọc hoặc tìm kiếm khác</p>
            </div>

            <!-- PAGINATION -->
            <div class="card-footer bg-white border-top-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        Hiển thị <span id="showingCount">@Model.Count()</span> trong tổng số <span id="totalCount">@Model.Count()</span> sản phẩm
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#"><i class="bi bi-chevron-left"></i></a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#"><i class="bi bi-chevron-right"></i></a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Filter products by search
    function filterProducts() {
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#productsTable tbody tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const isVisible = text.includes(searchValue);
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });

        updateEmptyState(visibleCount);
        updateShowingCount(visibleCount);
    }

    // Filter by status
    let currentFilter = 'all';
    function filterByStatus(status) {
        currentFilter = status;
        const rows = document.querySelectorAll('#productsTable tbody tr');
        let visibleCount = 0;

        // Update active chip
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        event.target.closest('.filter-chip').classList.add('active');

        rows.forEach(row => {
            const rowStatus = row.dataset.status;
            let isVisible = false;

            if (status === 'all') {
                isVisible = true;
            } else if (status === 'active' && rowStatus === 'active') {
                isVisible = true;
            } else if (status === 'inactive' && rowStatus === 'inactive') {
                isVisible = true;
            }

            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });

        updateEmptyState(visibleCount);
        updateShowingCount(visibleCount);
    }

    // Sort products
    function sortProducts(sortBy) {
        const tbody = document.querySelector('#productsTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            if (sortBy === 'name-asc' || sortBy === 'name-desc') {
                const nameA = a.querySelector('strong').textContent;
                const nameB = b.querySelector('strong').textContent;
                return sortBy === 'name-asc' ?
                    nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
            } else if (sortBy === 'price-asc' || sortBy === 'price-desc') {
                const priceA = parseInt(a.querySelector('.text-danger').textContent.replace(/\D/g, ''));
                const priceB = parseInt(b.querySelector('.text-danger').textContent.replace(/\D/g, ''));
                return sortBy === 'price-asc' ? priceA - priceB : priceB - priceA;
            }
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    // Toggle select all
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => {
            if (cb.closest('tr').style.display !== 'none') {
                cb.checked = selectAll.checked;
            }
        });
        updateBulkActions();
    }

    // Update bulk actions bar
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
        const bulkBar = document.getElementById('bulkActionsBar');
        const selectedCount = document.getElementById('selectedCount');

        if (checkedBoxes.length > 0) {
            bulkBar.style.display = 'block';
            selectedCount.textContent = checkedBoxes.length;
        } else {
            bulkBar.style.display = 'none';
            document.getElementById('selectAll').checked = false;
        }
    }

    // Bulk actions
    function bulkAction(action) {
        const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
        const ids = Array.from(checkedBoxes).map(cb => cb.closest('tr').dataset.id);

        if (confirm(`Bạn có chắc muốn ${action} ${ids.length} sản phẩm đã chọn?`)) {
            console.log(`${action} products:`, ids);
            // Add your AJAX call here
            alert('Chức năng đang được phát triển');
        }
    }

    // Toggle product status
    function toggleStatus(id, currentStatus) {
        if (confirm('Bạn có chắc muốn thay đổi trạng thái sản phẩm này?')) {
            console.log(`Toggle status for product ${id}`);
            // Add your AJAX call here
            alert('Chức năng đang được phát triển');
        }
    }

    // Delete product
    function deleteProduct(id, name) {
        if (confirm(`Bạn có chắc muốn xóa sản phẩm "${name}"?\nHành động này không thể hoàn tác!`)) {
            console.log(`Delete product ${id}`);
            // Add your AJAX call here
            alert('Chức năng đang được phát triển');
        }
    }

    // Export to Excel
    function exportToExcel() {
        alert('Chức năng xuất Excel đang được phát triển');
    }

    // Update empty state
    function updateEmptyState(visibleCount) {
        const emptyState = document.getElementById('emptyState');
        const table = document.querySelector('#productsTable');

        if (visibleCount === 0) {
            table.style.display = 'none';
            emptyState.style.display = 'block';
        } else {
            table.style.display = 'table';
            emptyState.style.display = 'none';
        }
    }

    // Update showing count
    function updateShowingCount(count) {
        document.getElementById('showingCount').textContent = count;
    }
</script>